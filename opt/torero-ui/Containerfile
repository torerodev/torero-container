FROM python:3.11-slim-bookworm

LABEL maintainer="torerodev <opensource@itential.com>"
LABEL org.opencontainers.image.source="https://github.com/torerodev/torero-ui"
LABEL org.opencontainers.image.description="torero dashboard web interface"
LABEL org.opencontainers.image.licenses="Apache-2.0"

# environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV DJANGO_SETTINGS_MODULE=torero_ui.settings

# application configuration
ENV TORERO_API_BASE_URL=http://localhost:8000
ENV DASHBOARD_REFRESH_INTERVAL=30
ENV DEBUG=False

# create app user
RUN useradd -m -s /bin/bash torero

# set working directory
WORKDIR /app

# copy application files
COPY . /app/

# install dependencies
RUN pip install --no-cache-dir -e .

# ensure database directory exists
RUN mkdir -p /app/data && chown torero:torero /app/data

# set up database
RUN python torero_ui/manage.py migrate

# collect static files
RUN python torero_ui/manage.py collectstatic --noinput

# create sample data for demo
RUN python torero_ui/manage.py create_test_data --count 15

# change ownership to app user
RUN chown -R torero:torero /app

# switch to app user
USER torero

# expose port
EXPOSE 8001

# health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
  CMD curl -f http://localhost:8001/ || exit 1

# start server
CMD ["python", "torero_ui/manage.py", "runserver", "0.0.0.0:8001"]